name: Build and Release

on:
  push:
    tags:
      - "*"

permissions:
  contents: write

jobs:
  build:
    name: Build (OpenWrt ${{ matrix.openwrt_version }} / ${{ matrix.arch }})
    if: ${{ vars.OPENWRT_VERSION == '' || vars.OPENWRT_VERSION == matrix.openwrt_version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - openwrt_version: 24.10.4
            arch: aarch64_cortex-a53
            target: bcm27xx
            subtarget: bcm2710
          - openwrt_version: 24.10.4
            arch: aarch64_cortex-a72
            target: mvebu
            subtarget: cortexa72
          - openwrt_version: 24.10.4
            arch: aarch64_generic
            target: layerscape
            subtarget: armv8_64b
          - openwrt_version: 24.10.4
            arch: arm_arm1176jzf-s_vfp
            target: bcm27xx
            subtarget: bcm2708
          - openwrt_version: 24.10.4
            arch: arm_arm926ej-s
            target: at91
            subtarget: sam9x
          - openwrt_version: 24.10.4
            arch: arm_cortex-a15_neon-vfpv4
            target: ipq806x
            subtarget: generic
          - openwrt_version: 24.10.4
            arch: arm_cortex-a5-vfpv4
            target: at91
            subtarget: sama5
          - openwrt_version: 24.10.4
            arch: arm_cortex-a7_neon-vfpv4
            target: bcm27xx
            subtarget: bcm2709
          - openwrt_version: 24.10.4
            arch: arm_cortex-a8_vfpv3
            target: sunxi
            subtarget: cortexa8
          - openwrt_version: 24.10.4
            arch: arm_cortex-a9
            target: bcm53xx
            subtarget: generic
          - openwrt_version: 24.10.4
            arch: arm_cortex-a9_neon
            target: imx
            subtarget: cortexa9
          - openwrt_version: 24.10.4
            arch: arm_cortex-a9_vfpv3-d16
            target: mvebu
            subtarget: cortexa9
          - openwrt_version: 24.10.4
            arch: arm_fa526
            target: gemini
            subtarget: generic
          - openwrt_version: 24.10.4
            arch: arm_xscale
            target: kirkwood
            subtarget: generic
          - openwrt_version: 24.10.4
            arch: i386_pentium
            target: x86
            subtarget: legacy
          - openwrt_version: 24.10.4
            arch: i386_pentium4
            target: x86
            subtarget: generic
          - openwrt_version: 24.10.4
            arch: mips64_octeonplus
            target: octeon
            subtarget: generic
          - openwrt_version: 24.10.4
            arch: mipsel_24kc
            target: ramips
            subtarget: mt7620
          - openwrt_version: 24.10.4
            arch: mipsel_24kc_24kf
            target: pistachio
            subtarget: generic
          - openwrt_version: 24.10.4
            arch: mipsel_74kc
            target: bcm47xx
            subtarget: mips74k
          - openwrt_version: 24.10.4
            arch: mipsel_mips32
            target: bcm47xx
            subtarget: generic
          - openwrt_version: 24.10.4
            arch: mips_24kc
            target: ath79
            subtarget: generic
          - openwrt_version: 24.10.4
            arch: mips_mips32
            target: bmips
            subtarget: bcm6362
          - openwrt_version: 24.10.4
            arch: x86_64
            target: x86
            subtarget: 64

          - openwrt_version: 24.10.5
            arch: aarch64_cortex-a53
            target: bcm27xx
            subtarget: bcm2710
          - openwrt_version: 24.10.5
            arch: aarch64_cortex-a72
            target: mvebu
            subtarget: cortexa72
          - openwrt_version: 24.10.5
            arch: aarch64_generic
            target: layerscape
            subtarget: armv8_64b
          - openwrt_version: 24.10.5
            arch: arm_arm1176jzf-s_vfp
            target: bcm27xx
            subtarget: bcm2708
          - openwrt_version: 24.10.5
            arch: arm_arm926ej-s
            target: at91
            subtarget: sam9x
          - openwrt_version: 24.10.5
            arch: arm_cortex-a15_neon-vfpv4
            target: ipq806x
            subtarget: generic
          - openwrt_version: 24.10.5
            arch: arm_cortex-a5-vfpv4
            target: at91
            subtarget: sama5
          - openwrt_version: 24.10.5
            arch: arm_cortex-a7_neon-vfpv4
            target: bcm27xx
            subtarget: bcm2709
          - openwrt_version: 24.10.5
            arch: arm_cortex-a8_vfpv3
            target: sunxi
            subtarget: cortexa8
          - openwrt_version: 24.10.5
            arch: arm_cortex-a9
            target: bcm53xx
            subtarget: generic
          - openwrt_version: 24.10.5
            arch: arm_cortex-a9_neon
            target: imx
            subtarget: cortexa9
          - openwrt_version: 24.10.5
            arch: arm_cortex-a9_vfpv3-d16
            target: mvebu
            subtarget: cortexa9
          - openwrt_version: 24.10.5
            arch: arm_fa526
            target: gemini
            subtarget: generic
          - openwrt_version: 24.10.5
            arch: arm_xscale
            target: kirkwood
            subtarget: generic
          - openwrt_version: 24.10.5
            arch: i386_pentium
            target: x86
            subtarget: legacy
          - openwrt_version: 24.10.5
            arch: i386_pentium4
            target: x86
            subtarget: generic
          - openwrt_version: 24.10.5
            arch: mips64_octeonplus
            target: octeon
            subtarget: generic
          - openwrt_version: 24.10.5
            arch: mipsel_24kc
            target: ramips
            subtarget: mt7620
          - openwrt_version: 24.10.5
            arch: mipsel_24kc_24kf
            target: pistachio
            subtarget: generic
          - openwrt_version: 24.10.5
            arch: mipsel_74kc
            target: bcm47xx
            subtarget: mips74k
          - openwrt_version: 24.10.5
            arch: mipsel_mips32
            target: bcm47xx
            subtarget: generic
          - openwrt_version: 24.10.5
            arch: mips_24kc
            target: ath79
            subtarget: generic
          - openwrt_version: 24.10.5
            arch: mips_mips32
            target: bmips
            subtarget: bcm6362
          - openwrt_version: 24.10.5
            arch: x86_64
            target: x86
            subtarget: 64

    env:
      OPENWRT_VERSION: ${{ vars.OPENWRT_VERSION || matrix.openwrt_version }}
      ARCH: ${{ matrix.arch }}
      CACHE_DIR: ~/cache
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Cache
        uses: actions/cache@v4
        with:
          path: ${{ env.CACHE_DIR }}
          key: ${{ runner.os }}:openwrt-frp:${{ env.ARCH }}:openwrt-${{ env.OPENWRT_VERSION }}:release:cache:${{ github.run_number }}
          restore-keys: |
            ${{ runner.os }}:openwrt-frp:${{ env.ARCH }}:openwrt-${{ env.OPENWRT_VERSION }}:cache:

      - name: Install Dependencies
        run: |
          sudo apt-get update && \
            sudo apt-get install -yq gettext libncurses5-dev rsync xsltproc

      - name: Prepare SDK Home
        run: |
          echo "SDK_HOME=$(mktemp -d)" >> $GITHUB_ENV

      - name: Build package
        env:
          SDK_URL_PATH: https://downloads.openwrt.org/releases/${{ env.OPENWRT_VERSION }}/targets/${{ matrix.target }}/${{ matrix.subtarget }}
          SDK_NAME: -sdk-${{ env.OPENWRT_VERSION }}-${{ matrix.target }}-${{ matrix.subtarget }}_
          OPENWRT_GOLANG_COMMIT: ${{ secrets.OPENWRT_GOLANG_COMMIT }}
        run: sh compile.sh

      - name: Normalize artifact filenames
        run: |
          openwrt="${OPENWRT_VERSION}"
          arch="${ARCH}"
          for f in *.ipk *.apk ; do
            [ -e "$f" ] || continue
            ext="${f##*.}"
            base="${f%.*}"
            mv "$f" "${base}_${openwrt}_${arch}.${ext}"
          done

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frp-${{ env.OPENWRT_VERSION }}-${{ matrix.arch }}
          path: |
            *.ipk
            *.apk
          retention-days: 7

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: frp-*
          merge-multiple: true
          path: dist

      - name: Create or Update Release
        env:
          GH_TOKEN: ${{ secrets.PAT || github.token }}
        run: |
          tag="${{ github.ref_name }}"

          files=()
          while IFS= read -r -d '' f ; do
            files+=("$f")
          done < <(find "dist" -type f \( -name "*.ipk" -o -name "*.apk" \) -print0)

          if [ "${#files[@]}" -eq 0 ] ; then
            echo "::error title=Release assets missing::No .ipk/.apk files found under dist/."
            exit 1
          fi

          if gh release view "$tag" >/dev/null 2>&1 ; then
            gh release upload "$tag" "${files[@]}" --clobber
          else
            gh release create "$tag" "${files[@]}" --title "$tag" --generate-notes
          fi
